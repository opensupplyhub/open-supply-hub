name: Code Quality Formatting

on:
  pull_request:
    types: [synchronize, opened, reopened]

jobs:
  run-linters-and-formatter:
    runs-on: ubuntu-latest
    environment:
      name: Quality Environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: echo "${{ secrets.CODE_QUALITY_ENV_FILE }}" > .env

      - name: Build Docker images
        run: docker-compose build

      - name: Run Flake8 linter
        run: docker-compose run --rm --no-deps --entrypoint flake8 django --exclude settings.py,manage.py,*.pyc,api/migrations/*

      - name: Install frontend NPM modules
        run: docker-compose run --rm --no-deps app yarn install

      - name: Run ESLint linter
        run: docker-compose run --rm --entrypoint ./node_modules/.bin/eslint app src/ --ext .js --ext .jsx

      - name: Run Prettier formatter check
        run: docker-compose run --rm --no-deps app yarn prettier --config .prettierrc --check 'src/**/*.js' 'src/**/*.jsx'
