# Generated by Django 2.2.24 on 2022-02-18 14:05
from collections import defaultdict

from django.db import migrations
from django.db.models import Q

from api.helpers.helpers import (
    parse_raw_data,
    get_csv_values,
    try_parse_int_from_float,
    format_custom_text
)


def get_list_contributor_field_values(item, fields):
    data_values = get_csv_values(item.raw_data)
    list_fields = get_csv_values(item.source.facility_list.header)
    for f in fields:
        if f['column_name'] in list_fields:
            index = list_fields.index(f['column_name'])
            if 0 <= index < len(data_values):
                value = data_values[index]
            else:
                value = None
            f['value'] = try_parse_int_from_float(value)

    return fields


def get_single_contributor_field_values(item, fields):
    data = parse_raw_data(item.raw_data)
    for f in fields:
        value = data.get(f['column_name'], None)
        if value is not None:
            f['value'] = try_parse_int_from_float(value)
    return fields


# Copied from api/models.py to ensure we use models for the migration
def get_custom_text(apps, facility_ids=list):
    Facility = apps.get_model('api', 'Facility')
    FacilityListItem = apps.get_model('api', 'FacilityListItem')
    EmbedField = apps.get_model('api', 'EmbedField')

    # If passed an empty array, update all facilities (where applicable)
    if len(facility_ids) == 0:
        print('Indexing custom text for all facilities...')
        facility_ids = Facility.objects.all().values_list('id', flat=True)

    # Get a list of searchable embed fields
    fields_filter = (Q(searchable=True) & Q(visible=True)
                     & Q(embed_config__isnull=False))
    fields = EmbedField.objects.filter(fields_filter)

    # Get a list of contributors with searchable fields
    contributor_ids = fields.values_list('embed_config__contributor',
                                         flat=True).distinct()

    # Get a list of active FacilityListItems for the given facilities.
    # Only include list items where the contributors have searchable fields.
    # Select the most recent item for each facility for each contributor.
    items_filter = (Q(facility_id__in=facility_ids)
                    & Q(source__contributor_id__in=contributor_ids)
                    & Q(source__is_active=True)
                    & Q(facilitymatch__is_active=True))
    items = FacilityListItem.objects.filter(items_filter) \
        .distinct('facility__id', 'source__contributor__id') \
        .order_by('facility__id', 'source__contributor__id', '-created_at') \
        .iterator()

    custom_fields = defaultdict(list)
    contributor_fields = defaultdict(list)

    for item in items:
        contributor_id = item.source.contributor.id

        # Calculate a list of searchable fields for the item's contributor
        if len(contributor_fields[contributor_id]) == 0:
            contributor_fields[contributor_id] = fields.filter(
                    Q(embed_config__contributor__id=contributor_id)) \
                    .values_list('column_name', flat=True)

        formatted_fields = [{'value': '', 'column_name': f} for f
                            in contributor_fields[contributor_id]]

        # Get the field values from the item for all of the submitting
        # contributor's searchable fields
        if item.source.source_type == 'SINGLE':
            item_fields = get_single_contributor_field_values(
                                    item,
                                    formatted_fields
                                )
        else:
            item_fields = get_list_contributor_field_values(
                                    item,
                                    formatted_fields
                                 )

        item_fields_array = [format_custom_text(contributor_id, f['value'])
                             for f in item_fields if f['value']]

        # Add the values to the dictionary entry for the item's facility
        custom_fields[item.facility.id] += item_fields_array

    return custom_fields





def do_nothing_on_reverse(apps, schema_editor):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('api', '0082_extend_facility_claim_facility_type_field_length'),
    ]

    operations = [
    ]
